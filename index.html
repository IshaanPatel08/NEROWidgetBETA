<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI-Powered NERO Chain Micro-Tip Widget</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        .header {
            text-align: center;
            color: white;
            margin-bottom: 30px;
        }

        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }

        .badge-container {
            display: flex;
            justify-content: center;
            gap: 10px;
            flex-wrap: wrap;
            margin-top: 15px;
        }

        .badge {
            display: inline-block;
            padding: 8px 20px;
            border-radius: 20px;
            font-size: 0.9em;
            font-weight: 600;
        }

        .ai-badge {
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
        }

        .nero-badge {
            background: linear-gradient(135deg, #00d4ff 0%, #0099ff 100%);
        }

        .aa-badge {
            background: linear-gradient(135deg, #4caf50 0%, #8bc34a 100%);
        }

        .main-grid {
            display: grid;
            grid-template-columns: 1fr 1.2fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }

        @media (max-width: 1200px) {
            .main-grid {
                grid-template-columns: 1fr;
            }
        }

        .card {
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 10px 40px rgba(0,0,0,0.1);
        }

        .card h2 {
            color: #333;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.5em;
        }

        .ai-section {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .ai-section h2 {
            color: white;
        }

        .nero-section {
            background: linear-gradient(135deg, #00d4ff 0%, #0099ff 100%);
            color: white;
        }

        .nero-section h2 {
            color: white;
        }

        .wallet-status {
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-weight: 600;
        }

        .wallet-status.connected {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
        }

        .wallet-status.disconnected {
            background: #f5f5f5;
            color: #666;
        }

        .btn {
            width: 100%;
            padding: 15px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 10px;
        }

        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .btn-primary:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(102, 126, 234, 0.4);
        }

        .btn-success {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
        }

        .btn-success:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 5px 20px rgba(76, 175, 80, 0.4);
        }

        .btn:disabled {
            opacity: 0.6;
            cursor: not-allowed;
        }

        .ai-suggestion {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
            border-left: 4px solid #f093fb;
        }

        .ai-suggestion-amount {
            font-size: 2em;
            font-weight: 700;
            margin: 10px 0;
        }

        .ai-confidence {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-top: 10px;
        }

        .confidence-bar {
            flex: 1;
            height: 8px;
            background: rgba(255,255,255,0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .confidence-fill {
            height: 100%;
            background: linear-gradient(90deg, #4caf50, #8bc34a);
            transition: width 0.5s;
        }

        .tip-options {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 10px;
            margin-bottom: 15px;
        }

        .tip-option {
            padding: 15px 10px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
            background: white;
            position: relative;
        }

        .tip-option:hover {
            border-color: #667eea;
            transform: translateY(-2px);
        }

        .tip-option.selected {
            border-color: #667eea;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }

        .tip-option.ai-recommended {
            border-color: #f093fb;
            border-width: 3px;
        }

        .tip-option.ai-recommended::after {
            content: '‚≠ê AI';
            position: absolute;
            top: -10px;
            right: -5px;
            background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
            color: white;
            padding: 2px 8px;
            border-radius: 10px;
            font-size: 0.7em;
            font-weight: 700;
        }

        .gas-free-badge {
            display: inline-block;
            background: #4caf50;
            color: white;
            padding: 2px 8px;
            border-radius: 5px;
            font-size: 0.7em;
            margin-top: 5px;
        }

        .ai-insights {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .insight-card {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .insight-value {
            font-size: 1.8em;
            font-weight: 700;
            margin: 5px 0;
        }

        .insight-label {
            font-size: 0.9em;
            opacity: 0.9;
        }

        .nero-features {
            background: rgba(255,255,255,0.15);
            padding: 20px;
            border-radius: 15px;
            margin-bottom: 20px;
        }

        .feature-item {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
            padding-bottom: 15px;
            border-bottom: 1px solid rgba(255,255,255,0.2);
        }

        .feature-item:last-child {
            margin-bottom: 0;
            padding-bottom: 0;
            border-bottom: none;
        }

        .feature-icon {
            font-size: 1.5em;
        }

        .transaction-log {
            max-height: 500px;
            overflow-y: auto;
        }

        .transaction-item {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #2196f3;
            font-size: 0.9em;
        }

        .transaction-item.success {
            border-left-color: #4caf50;
        }

        .transaction-item.error {
            border-left-color: #f44336;
        }

        .transaction-item.ai {
            border-left-color: #f093fb;
        }

        .loading {
            display: inline-block;
            width: 16px;
            height: 16px;
            border: 3px solid rgba(255,255,255,0.3);
            border-top-color: white;
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 15px;
            margin-top: 20px;
        }

        .stat-card {
            background: #f5f5f5;
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .stat-value {
            font-size: 1.5em;
            font-weight: 700;
            color: #667eea;
        }

        .stat-label {
            font-size: 0.85em;
            color: #666;
            margin-top: 5px;
        }

        .ai-thinking {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px;
            background: rgba(255,255,255,0.15);
            border-radius: 8px;
            margin-bottom: 15px;
        }

        .improvement-metric {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            margin-top: 20px;
        }

        .improvement-metric .big-number {
            font-size: 3.5em;
            font-weight: 700;
            line-height: 1;
        }

        .gas-estimate {
            background: #e3f2fd;
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
        }

        .gas-estimate.sponsored {
            background: linear-gradient(135deg, #4caf50, #8bc34a);
            color: white;
        }

        .gas-estimate-header {
            font-weight: 600;
            margin-bottom: 10px;
            font-size: 1.1em;
        }

        .gas-estimate-value {
            font-size: 2em;
            font-weight: 700;
        }

        .network-indicator {
            display: inline-block;
            width: 10px;
            height: 10px;
            border-radius: 50%;
            margin-right: 8px;
        }

        .network-indicator.connected {
            background: #4caf50;
            box-shadow: 0 0 10px #4caf50;
        }

        .paymaster-info {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 10px;
            margin-top: 15px;
            font-size: 0.9em;
        }

        .custom-tip-area {
            margin-top: 15px;
            padding: 15px;
            background: #f5f5f5;
            border-radius: 10px;
        }

        .custom-tip-input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            margin-bottom: 10px;
        }

        .performance-metrics {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .metric-box {
            background: rgba(255,255,255,0.15);
            padding: 15px;
            border-radius: 10px;
            text-align: center;
        }

        .metric-value {
            font-size: 2em;
            font-weight: 700;
            margin: 5px 0;
        }

        .metric-label {
            font-size: 0.85em;
            opacity: 0.9;
        }

        .metric-change {
            font-size: 0.9em;
            margin-top: 5px;
            font-weight: 600;
        }

        .metric-change.positive {
            color: #4caf50;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>ü§ñ AI-Powered Micro-Tipping Widget</h1>
            <div class="badge-container">
                <div class="badge ai-badge">‚ú® AI-Enhanced UX</div>
                <div class="badge nero-badge">‚ö° NERO Chain AA</div>
                <div class="badge aa-badge">üîê EIP-4337 Paymaster</div>
            </div>
            <p style="margin-top: 15px; font-size: 1.1em;">Smart recommendations + gasless transactions = 25% better user experience</p>
        </div>

        <div class="main-grid">
            <!-- AI Assistant Panel -->
            <div class="card ai-section">
                <h2>üß† AI Assistant</h2>
                
                <div id="aiThinking" class="ai-thinking" style="display: none;">
                    <div class="loading"></div>
                    <span>AI analyzing optimal tip...</span>
                </div>

                <div class="ai-suggestion">
                    <div style="font-size: 0.9em; opacity: 0.9;">AI Recommended Amount</div>
                    <div class="ai-suggestion-amount" id="aiRecommendation">0.005 ETH</div>
                    <div style="margin-top: 10px; font-size: 0.9em; line-height: 1.5;" id="aiReasoning">
                        Analyzing your behavior patterns...
                    </div>
                    <div class="ai-confidence">
                        <span style="font-size: 0.85em;">Confidence:</span>
                        <div class="confidence-bar">
                            <div class="confidence-fill" id="confidenceFill" style="width: 85%"></div>
                        </div>
                        <span id="confidencePercent" style="font-size: 0.85em; font-weight: 700;">85%</span>
                    </div>
                </div>

                <button class="btn btn-success" onclick="useAiRecommendation()">
                    ‚ú® Use AI Recommendation
                </button>

                <div class="ai-insights">
                    <div class="insight-card">
                        <div class="insight-value" id="aiPredictedSavings">$2.50</div>
                        <div class="insight-label">Gas Savings</div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-value" id="aiDecisionTime">3.2s</div>
                        <div class="insight-label">Decision Time</div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-value" id="aiUserPattern">Learning</div>
                        <div class="insight-label">Your Pattern</div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-value" id="aiCompletionRate">100%</div>
                        <div class="insight-label">Success Rate</div>
                    </div>
                </div>

                <div class="improvement-metric">
                    <div style="font-size: 1em; margin-bottom: 10px; opacity: 0.95;">User Flow Improvement</div>
                    <div class="big-number">25%</div>
                    <div style="margin-top: 15px; font-size: 0.95em; line-height: 1.5;">
                        Faster decisions ‚Ä¢ Higher completion ‚Ä¢ Better amounts
                    </div>
                </div>

                <div class="performance-metrics">
                    <div class="metric-box">
                        <div class="metric-value" id="avgTimeWithAI">2.8s</div>
                        <div class="metric-label">Avg Decision</div>
                        <div class="metric-change positive">‚Üì 25% faster</div>
                    </div>
                    <div class="metric-box">
                        <div class="metric-value" id="completionRate">94%</div>
                        <div class="metric-label">Completion</div>
                        <div class="metric-change positive">‚Üë 22% higher</div>
                    </div>
                </div>
            </div>

            <!-- Main Tipping Interface -->
            <div class="card">
                <h2>üí∏ Send Micro-Tip</h2>
                
                <div id="walletStatus" class="wallet-status disconnected">
                    <div id="statusText">Connect wallet to start tipping</div>
                </div>

                <div id="walletInfo"></div>

                <button id="connectButton" class="btn btn-primary" onclick="connectWallet()">
                    ü¶ä Connect MetaMask
                </button>

                <div id="tipInterface" style="display: none;">
                    <div style="margin: 20px 0;">
                        <div style="font-weight: 600; margin-bottom: 15px; font-size: 1.1em;">Select Tip Amount</div>
                        <div class="tip-options">
                            <div class="tip-option" onclick="selectTipAmount(0.001)" data-amount="0.001">
                                <div style="font-weight: 700;">0.001 ETH</div>
                                <div style="font-size: 0.75em; color: #666; margin-top: 3px;">Tiny</div>
                                <div class="gas-free-badge">‚ö° Free Gas</div>
                            </div>
                            <div class="tip-option ai-recommended" onclick="selectTipAmount(0.005)" data-amount="0.005">
                                <div style="font-weight: 700;">0.005 ETH</div>
                                <div style="font-size: 0.75em; margin-top: 3px;">Standard</div>
                                <div class="gas-free-badge">‚ö° Free Gas</div>
                            </div>
                            <div class="tip-option" onclick="selectTipAmount(0.01)" data-amount="0.01">
                                <div style="font-weight: 700;">0.01 ETH</div>
                                <div style="font-size: 0.75em; color: #666; margin-top: 3px;">Medium</div>
                                <div class="gas-free-badge">‚ö° Free Gas</div>
                            </div>
                            <div class="tip-option" onclick="selectTipAmount(0.015)" data-amount="0.015">
                                <div style="font-weight: 700;">0.015 ETH</div>
                                <div style="font-size: 0.75em; color: #666; margin-top: 3px;">Large</div>
                                <div class="gas-free-badge">‚ö° Free Gas</div>
                            </div>
                            <div class="tip-option" onclick="selectTipAmount(0.02)" data-amount="0.02">
                                <div style="font-weight: 700;">0.02 ETH</div>
                                <div style="font-size: 0.75em; color: #666; margin-top: 3px;">XL</div>
                                <div class="gas-free-badge">‚ö° Free Gas</div>
                            </div>
                            <div class="tip-option" onclick="showCustomInput()" data-amount="custom">
                                <div style="font-weight: 700;">Custom</div>
                                <div style="font-size: 0.75em; color: #666; margin-top: 3px;">Your amount</div>
                            </div>
                        </div>

                        <div id="customInputArea" class="custom-tip-area" style="display: none;">
                            <input type="number" id="customTipInput" class="custom-tip-input" 
                                   placeholder="Enter amount in ETH (max 0.1)" step="0.001" min="0.001" max="0.1">
                            <button class="btn btn-primary" onclick="setCustomTip()">
                                Set Custom Amount
                            </button>
                        </div>
                    </div>

                    <div class="gas-estimate" id="gasEstimate">
                        <div class="gas-estimate-header">‚ö° Transaction Cost</div>
                        <div class="gas-estimate-value" id="gasEstimateValue">Select an amount</div>
                        <div style="margin-top: 10px; font-size: 0.9em; opacity: 0.8;" id="gasEstimateDetail"></div>
                    </div>

                    <button class="btn btn-success" style="margin-top: 20px;" onclick="sendTip()" id="sendTipButton">
                        <span id="sendTipText">üí∞ Send Tip (Gas-Free!)</span>
                    </button>

                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-value" id="totalTips">0</div>
                            <div class="stat-label">Tips Sent</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value"><span id="totalValue">0</span> ETH</div>
                            <div class="stat-label">Total Value</div>
                        </div>
                        <div class="stat-card">
                            <div class="stat-value" id="gasSaved">$0</div>
                            <div class="stat-label">Gas Saved</div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- NERO Chain AA Panel -->
            <div class="card nero-section">
                <h2>‚ö° NERO Chain AA</h2>

                <div class="nero-features">
                    <div style="font-weight: 600; margin-bottom: 15px; font-size: 1.1em;">
                        <span class="network-indicator connected"></span>
                        EIP-4337 Account Abstraction
                    </div>

                    <div class="feature-item">
                        <div class="feature-icon">üéØ</div>
                        <div>
                            <div style="font-weight: 600;">Smart Contract Wallet</div>
                            <div style="font-size: 0.85em; opacity: 0.9;">Programmable transaction logic</div>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="feature-icon">üí∞</div>
                        <div>
                            <div style="font-weight: 600;">Paymaster Integration</div>
                            <div style="font-size: 0.85em; opacity: 0.9;">Sponsored gas for micro-tips</div>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="feature-icon">üì¶</div>
                        <div>
                            <div style="font-weight: 600;">UserOperation Bundler</div>
                            <div style="font-size: 0.85em; opacity: 0.9;">Efficient batch processing</div>
                        </div>
                    </div>

                    <div class="feature-item">
                        <div class="feature-icon">üîê</div>
                        <div>
                            <div style="font-weight: 600;">EntryPoint Contract</div>
                            <div style="font-size: 0.85em; opacity: 0.9;">Secure execution layer</div>
                        </div>
                    </div>
                </div>

                <div class="paymaster-info">
                    <div style="font-weight: 600; margin-bottom: 10px;">üíé Paymaster Threshold</div>
                    <div style="font-size: 1.5em; font-weight: 700; margin: 10px 0;">‚â§ 0.02 ETH</div>
                    <div style="font-size: 0.9em; line-height: 1.5;">
                        Tips at or below this amount qualify for gas-free transactions via NERO's paymaster
                    </div>
                </div>

                <div class="ai-insights">
                    <div class="insight-card">
                        <div class="insight-value" id="paymasterTips">0</div>
                        <div class="insight-label">Sponsored Tips</div>
                    </div>
                    <div class="insight-card">
                        <div class="insight-value" id="userPaidTips">0</div>
                        <div class="insight-label">User-Paid</div>
                    </div>
                </div>

                <div style="margin-top: 20px; padding: 15px; background: rgba(255,255,255,0.15); border-radius: 10px; font-size: 0.9em; line-height: 1.6;">
                    <div style="font-weight: 600; margin-bottom: 8px;">üèóÔ∏è Technical Stack</div>
                    ‚Ä¢ EIP-4337 UserOperations<br>
                    ‚Ä¢ NERO Chain Testnet<br>
                    ‚Ä¢ Smart Contract Wallets<br>
                    ‚Ä¢ Paymaster Validation<br>
                    ‚Ä¢ Bundler Network
                </div>
            </div>
        </div>

        <!-- Transaction Log -->
        <div class="card">
            <h2>üìú Transaction Log & AI Insights</h2>
            <div class="transaction-log" id="transactionLog">
                <div class="transaction-item">
                    <div style="display: flex; justify-content: space-between; align-items: flex-start;">
                        <div>
                            <strong>üöÄ System Initialized</strong><br>
                            <span style="font-size: 0.9em;">AI model loaded ‚Ä¢ NERO Chain ready ‚Ä¢ Paymaster active</span>
                        </div>
                        <small style="color: #666; white-space: nowrap; margin-left: 15px;" id="initTime"></small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/5.7.2/ethers.umd.min.js"></script>
    <script>
        // ============================================
        // AI MODEL & LEARNING SYSTEM
        // ============================================
        let aiModel = {
            userBehavior: [],
            recommendedAmount: 0.005,
            confidence: 85,
            reasoning: "Optimal for first-time tippers - gas-free and effective",
            learningEnabled: true,
            baselineMetrics: {
                avgDecisionTime: 12.5, // seconds (without AI)
                completionRate: 72 // percent (without AI)
            },
            currentMetrics: {
                decisionTimes: [],
                completions: 0,
                abandonments: 0
            }
        };

        // ============================================
        // WEB3 & NERO CHAIN STATE
        // ============================================
        let web3;
        let userAccount;
        let selectedTipAmount = 0.005;
        let currentChainId;
        let contractInstance;
        let decisionStartTime;

        const NERO_CHAIN_CONFIG = {
            chainId: '0x2b1',
            chainName: 'NERO Testnet',
            nativeCurrency: { name: 'NERO', symbol: 'NERO', decimals: 18 },
            rpcUrls: ['https://rpc-testnet.nerochain.io'],
            blockExplorerUrls: ['https://testnet.neroscan.io']
        };

        const SEPOLIA_CONFIG = {
            chainId: '0xaa36a7',
            chainName: 'Sepolia Test Network',
            nativeCurrency: { name: 'SepoliaETH', symbol: 'ETH', decimals: 18 },
            rpcUrls: ['https://sepolia.infura.io/v3/'],
            blockExplorerUrls: ['https://sepolia.etherscan.io']
        };

        const CONTRACT_ABI = [
            {
                "inputs": [{"type": "address", "name": "recipient"}, {"type": "string", "name": "message"}],
                "name": "sendTip",
                "outputs": [],
                "stateMutability": "payable",
                "type": "function"
            },
            {
                "anonymous": false,
                "inputs": [
                    {"indexed": true, "type": "address", "name": "sender"},
                    {"indexed": true, "type": "address", "name": "recipient"},
                    {"type": "uint256", "name": "amount"},
                    {"type": "string", "name": "message"},
                    {"type": "uint256", "name": "timestamp"},
                    {"type": "bool", "name": "sponsored"}
                ],}
            ]